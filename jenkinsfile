pipeline {
    agent any

    stages {  
        stage('Setup Environment') {
            steps {
                echo "Setting up virtual environment inside python-runner..."
                sh '''
                    docker exec python-runner bash -c "
                        python3 -m venv venv &&
                        . venv/bin/activate &&
                        pip install --upgrade pip &&
                        
                    "
                '''
            }
        }

        stage('Run Tests') {
            steps {
                echo "Running pytest inside python-runner..."
                sh '''
                    docker exec python-runner bash -c "
                        . venv/bin/activate &&
                        python api.py
                    "
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline execution completed."
        }
        failure {
            echo "❌ Some tests failed."
        }
        success {
            echo "✅ All tests passed successfully."
        }
    }
}